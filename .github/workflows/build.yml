name: Project Build
run-name: "📦 Project Build #${{ github.run_number }}"
on:
  push:
    branches:
      - dev
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEV_ENVIRONMENT: ${{ github.ref_name != 'main' }}

jobs:    
  info:
    name: 🖥️ Project Info
    runs-on: ubuntu-latest
    
    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
        
      - name: 🔍 Check pakku-lock.json
        id: check_pakku_lock
        shell: bash
        run: |
          if [ ! -f pakku-lock.json ]; then
            echo "❌ Could not find pakku-lock.json" && exit 1
          else
            echo "✔️ pakku-lock.json"
          fi
        
      - name: 🔍 Check pakku.json
        id: check_pakku
        shell: bash
        run: |
          if [ ! -f pakku.json ]; then
            echo "❌ Could not find pakku.json" && exit 1
          else
            echo "✔️ pakku.json"
          fi
  
  build-project:
    name: 📦 Build Project
    needs: [info]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: 📝 Cache pakku
        uses: actions/cache@v4.3.0
        id: cache
        with:
          path: build/.cache
          key: pakku-cache-${{ hashFiles('pakku-lock.json') }}
          restore-keys: pakku-cache-

      - name: 📦 Export modpack
        run: |
          curl https://github.com/juraj-hrivnak/pakku/releases/latest/download/pakku.jar -o pakku.jar -L -J
          java -jar pakku.jar --version
          echo 'running fetch'
          java -jar pakku.jar --debug fetch
          echo 'running export'
          java -jar pakku.jar --debug export

          mkdir -p .pakku/multimc-overrides/flame
          mkdir -p .pakku/multimc-overrides/mods
